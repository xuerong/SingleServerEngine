## 集群
###1.MMServerEngine的集群 
MMSE的集群是指多个程序实例同时运行在多个物理机上面，多个实例之间通过网络通信和共用存储空间使得对应用逻辑编写者来讲，只要按照要求的规则编写应用逻辑，就可以将其当做运行在一台物理机上面的一个应用。由于实际上还是运行在多个物理机上面的多个实例，使用的时候没有像运行一个实例那么方便，单一任务运行的效率也会相对较低，但是，通过集群可以更好的分担大量的平行任务，使得集群作为一个整体可以达到单台物理机无法达到的任务负载能力。集群中也会使用很多的方法减少集群导致的应用运行效率的降低，如缓存，异步等。<br>
MMServerEngine集群中有三种服务器实例，主服务器（mainServer），节点服务器（nodeServer）和异步服务器（asyncServer），其中主服务器和异步服务器各自有一个运行实例，节点服务器可以有多个。三者之间的关系参见“基本框架结构-集群框架”<br>
mainServer 的功能：第一，应用客户端的入口，负责给应用客户端分配nodeServer；第二，单服务的运行（目前），包括加载的持久化的job，单服务器运行的update，锁服务，singleService等；第三，负责部分多服务器之间的通信等；第四，所有登陆玩家的登陆状态和所有服务器的状态。等
nodeServer的功能：玩家实际登陆的服务器，主要应用功能逻辑的执行服务器，包括非singleService和room服务。<br>
asyncServer的功能：异步持久化数据的服务器，负责将应用逻辑对数据库的操作异步更新到数据库。<br>
同一个服务器实例可以是多种类型的服务器，如既是mainServer又是nodeServer。

###2.问题及解决方案 
不同实例之间的通信是通过netEvent完成的，具体参见“netEvent与RPC”。但通过通信来完成服务器之间沟通会导致多种问题。
####1)数据的可见性问题。 
因为每个实例拥有自己的缓存空间，如果将数据存储（或暂时存储）在自身实例中，就可能导致不同实例之间的数据是不可见的。解决方法是，使用共用缓存空间，所有的数据交互都是对共用缓存空间操作，实例自身要么不缓存数据，要么确保缓存的数据与共用缓存空间是同步的。具体参见“缓存与异步持久化”

####2)第二，数据的一致性问题。 
在一个实例中，如果有多个线程对同一个数据进行操作，需要通过给各个线程加锁来确保数据的一致性，而在集群中不同实例是无法使用同样的加锁操作。解决方法是，提供一个运行在一个服务器上面的“字符串”加锁服务，集群所有实例可以根据需求来设计统一的字符串作为锁，只有获取该字符串的锁，才能继续相应的数据操作。参考“服务层事务-所服务”。

####3)第三，推送数据的问题。 
集群中的不同玩家运行在多个nodeServer上，每个nodeServer只记录登陆自己的玩家状态，并不知道其它玩家的存在，而如果某个功能需要向未在该服务器上登陆的玩家推送消息。解决方法是，mainServer记录了所有的登陆玩家的状态，未在本服务器登陆的玩家的推送交给mainServer，由其交给该玩家登陆的nodeServer推送。

####4)第四，有些服务只能运行一个实例。 
singleService是解决单实例运行的方案，当一个服务配置为singleService时，它将只在一个实例上面运行（目前为mainServer），此时可以用作全缓存服务，其它实例都将采用远程调用来完成函数的调用。在非singleService运行的服务器实例上，@EventListener，@NetEventListener，@Updatable和@Gm将不在起作用，@Request将远程调用singleService运行的服务器实例上面的对应方法。

###3.瓶颈 
可能导致瓶颈的地方：singleService，asyncServer，locker，cache
